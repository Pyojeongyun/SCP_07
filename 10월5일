#include <LiquidCrystal_I2C.h>

LiquidCrystal_I2C lcd(0x3F,16,2);

#define TRIG 2 //초음파 보냄
#define ECHO 3 //돌아오는 초음파 감지
#define RED 11
#define GREEN 10

long color=0;    //color변수는 LED불빛이 빨간색인지 초록색인지 구별할수있게 해주는 변수
long fee=0;

unsigned long charge=0;
unsigned long t1=0;
unsigned long t2=0;

void setup()
{
  Serial.begin(9600);
  pinMode(TRIG, OUTPUT); 
  pinMode(ECHO, INPUT); 
  pinMode(GREEN, OUTPUT);
  pinMode(RED, OUTPUT); 

  lcd.init();
  lcd.backlight();
}

void loop()
{
  digitalWrite(TRIG, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG, LOW);

  long distance = pulseIn(ECHO, HIGH)/58.2;    //측정한 거리를 cm단위로 변환시켜주는 식

  analogWrite(RED, 0);
  analogWrite(GREEN, 10);

  if(distance<10){               //대형차 일 때
    if(color==0){
      charge=1000;
      t1 = millis();
    }
    analogWrite(GREEN, 0);
    analogWrite(RED, 10);
    color=1;
    lcd.init();                    //자릿수 바뀔 때 출오류 방지위해 초기화
    lcd.backlight();
  }


  else if(distance <20){           //소형차 일 때
    if(color==0){
       charge=500;
      t1 = millis();
    }
    analogWrite(GREEN, 0);
    analogWrite(RED, 10);
    color=1;
    lcd.init();
    lcd.backlight();
  }

  else {                            //주차된 차가 나갈 때
    if(color==1){
      t2 = millis();
    }
    analogWrite(RED, 0);
    analogWrite(GREEN, 10);
    color=0;
    fee=charge*((int)(t2-t1)/1000);                 //차종에 맞게 요금계산
    
    if(charge!=0)                       //출력 반복되는것을 피하기위해서
    {
      lcd.setCursor(0, 0);
      lcd.print((int)(t2-t1)/1000);
      lcd.setCursor(5,0);
      lcd.print("seconds");
      
      lcd.setCursor(0, 1);
      lcd.print(fee);
      lcd.setCursor(5,1);
      lcd.print("Won");
      charge=0;
    }
  }
  delay(100);
}
